name: AI-Driven DevSecOps Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    # Run daily security scans at 2 AM UTC
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Job 1: SAST with Semgrep
  sast_scan:
    name: Static Analysis (SAST)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Semgrep
        run: |
          pip install --upgrade pip
          pip install semgrep
      
      - name: Run Semgrep SAST Scan
        run: |
          mkdir -p results
          echo "Running Semgrep with custom rules..."
          semgrep --config semgrep-rules/ \
                  --json \
                  --output results/semgrep.json \
                  --metrics=off \
                  --verbose || true
          
          # Also run with community rules for comprehensive coverage
          semgrep --config "p/security-audit" \
                  --config "p/owasp-top-ten" \
                  --json \
                  --output results/semgrep_community.json \
                  --metrics=off || true
      
      - name: Display Semgrep Summary
        run: |
          if [ -f results/semgrep.json ]; then
            echo "âœ… Semgrep scan completed"
            python -c "import json; data=json.load(open('results/semgrep.json')); print(f'Found {len(data.get(\"results\", []))} potential issues')"
          else
            echo "âš ï¸ No Semgrep results found"
          fi
      
      - name: Upload Semgrep Results
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: results/semgrep*.json
          retention-days: 30
          if-no-files-found: warn

  # Job 2: DAST with OWASP ZAP
  dast_scan:
    name: Dynamic Analysis (DAST)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Vulnerable App Dependencies
        run: |
          cd Vulnerable_app
          pip install -r requirements.txt || pip install flask flask-sqlalchemy
      
      - name: Start Vulnerable Application
        run: |
          cd Vulnerable_app
          nohup python app.py > ../app.log 2>&1 &
          echo $! > ../app.pid
          sleep 5
          
          # Verify app is running
          if curl -s http://localhost:5000 > /dev/null; then
            echo "âœ… Application started successfully"
          else
            echo "âš ï¸ Application may not be running properly"
            cat ../app.log
          fi
      
      - name: Create Results Directory
        run: mkdir -p results
      
      - name: Run OWASP ZAP Baseline Scan
        run: |
          docker run --rm \
            --network="host" \
            -v $(pwd)/results:/zap/wrk/:rw \
            -v $(pwd)/zap:/zap/config/:ro \
            owasp/zap2docker-stable \
            zap-baseline.py \
            -t http://localhost:5000 \
            -J zap_report.json \
            -r zap_report.html \
            -w zap_report.md \
            -c zap-config.yml \
            -d || true
      
      - name: Run OWASP ZAP Full Scan (API)
        run: |
          docker run --rm \
            --network="host" \
            -v $(pwd)/results:/zap/wrk/:rw \
            owasp/zap2docker-stable \
            zap-api-scan.py \
            -t http://localhost:5000 \
            -f openapi \
            -J zap_api_report.json \
            -d || true
      
      - name: Stop Vulnerable Application
        if: always()
        run: |
          if [ -f app.pid ]; then
            kill $(cat app.pid) || true
            rm app.pid
          fi
      
      - name: Display ZAP Summary
        run: |
          if [ -f results/zap_report.json ]; then
            echo "âœ… ZAP scan completed"
            python -c "import json; data=json.load(open('results/zap_report.json')); print(f'Found {len(data.get(\"site\", [{}])[0].get(\"alerts\", []))} alerts')" || echo "Results available"
          else
            echo "âš ï¸ No ZAP results found"
          fi
      
      - name: Upload ZAP Results
        uses: actions/upload-artifact@v4
        with:
          name: zap-results
          path: results/zap*.json
          retention-days: 30
          if-no-files-found: warn
      
      - name: Upload ZAP Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            results/zap*.html
            results/zap*.md
          retention-days: 30
          if-no-files-found: ignore

  # Job 3: AI Processing and Analysis
  ai_analysis:
    name: AI Vulnerability Analysis
    runs-on: ubuntu-latest
    needs: [sast_scan, dast_scan]
    permissions:
      contents: read
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install AI Engine Dependencies
        run: |
          cd ai-engine
          pip install -r requirements.txt
      
      - name: Download Semgrep Results
        uses: actions/download-artifact@v4
        with:
          name: semgrep-results
          path: results/sast/
        continue-on-error: true
      
      - name: Download ZAP Results
        uses: actions/download-artifact@v4
        with:
          name: zap-results
          path: results/dast/
        continue-on-error: true
      
      - name: List Downloaded Results
        run: |
          echo "ðŸ“ Downloaded scan results:"
          ls -R results/ || echo "No results directory"
      
      - name: Run AI Analysis Engine
        run: |
          cd ai-engine
          python main.py \
            --sast-results ../results/sast/ \
            --dast-results ../results/dast/ \
            --policy ../config/policy.yml \
            --output ../results/ai_analysis.json \
            --verbose
      
      - name: Generate Analysis Summary
        run: |
          if [ -f results/ai_analysis.json ]; then
            echo "âœ… AI Analysis completed successfully"
            python -c "
import json
with open('results/ai_analysis.json') as f:
    data = json.load(f)
    summary = data.get('summary', {})
    print(f\"ðŸ“Š Analysis Summary:\")
    print(f\"  Total Vulnerabilities: {summary.get('total_vulnerabilities', 0)}\")
    print(f\"  After Filtering: {summary.get('filtered_vulnerabilities', 0)}\")
    print(f\"  False Positive Rate: {summary.get('false_positive_rate', 0):.1%}\")
    print(f\"  Critical: {summary.get('by_severity', {}).get('CRITICAL', 0)}\")
    print(f\"  High: {summary.get('by_severity', {}).get('HIGH', 0)}\")
    print(f\"  Medium: {summary.get('by_severity', {}).get('MEDIUM', 0)}\")
    print(f\"  Low: {summary.get('by_severity', {}).get('LOW', 0)}\")
            " || echo "Summary not available"
          else
            echo "âš ï¸ AI analysis output not found"
          fi
      
      - name: Upload AI Analysis Results
        uses: actions/upload-artifact@v4
        with:
          name: ai-analysis
          path: results/ai_analysis.json
          retention-days: 90
      
      - name: Check Security Gate
        run: |
          cd ai-engine
          python -c "
import json
import sys

with open('../results/ai_analysis.json') as f:
    data = json.load(f)

summary = data.get('summary', {})
critical = summary.get('by_severity', {}).get('CRITICAL', 0)
high = summary.get('by_severity', {}).get('HIGH', 0)

print(f'ðŸ”’ Security Gate Check:')
print(f'  Critical vulnerabilities: {critical}')
print(f'  High vulnerabilities: {high}')

# Fail if blocking severities found (based on policy)
if critical > 0:
    print('âŒ FAILED: Critical vulnerabilities found!')
    sys.exit(1)
elif high > 0:
    print('âš ï¸  WARNING: High severity vulnerabilities found!')
    print('   Review required before deployment')
    # Uncomment to block on HIGH severity:
    # sys.exit(1)
else:
    print('âœ… PASSED: No blocking vulnerabilities found')
          " || echo "Security gate check failed"

  # Job 4: Build and Deploy Dashboard
  dashboard:
    name: Build Security Dashboard
    runs-on: ubuntu-latest
    needs: [ai_analysis]
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: dashboard/package-lock.json
      
      - name: Download AI Analysis
        uses: actions/download-artifact@v4
        with:
          name: ai-analysis
          path: dashboard/public/data/
        continue-on-error: true
      
      - name: Install Dashboard Dependencies
        run: |
          cd dashboard
          npm ci
      
      - name: Build Dashboard
        run: |
          cd dashboard
          npm run build
      
      - name: Upload Dashboard Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-build
          path: dashboard/dist/
          retention-days: 30
      
      # Uncomment to deploy to GitHub Pages
      # - name: Deploy to GitHub Pages
      #   uses: peaceiris/actions-gh-pages@v3
      #   if: github.ref == 'refs/heads/main'
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: ./dashboard/dist

  # Job 5: Aggregate All Results
  aggregate_results:
    name: Aggregate and Archive Results
    runs-on: ubuntu-latest
    needs: [sast_scan, dast_scan, ai_analysis, dashboard]
    if: always()
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Create Aggregation Directory
        run: mkdir -p aggregated/{raw,processed,reports}
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: aggregated/
      
      - name: Organize Results
        run: |
          # Move raw scan results
          mv aggregated/semgrep-results/* aggregated/raw/ 2>/dev/null || true
          mv aggregated/zap-results/* aggregated/raw/ 2>/dev/null || true
          
          # Move processed results
          mv aggregated/ai-analysis/* aggregated/processed/ 2>/dev/null || true
          
          # Move reports
          mv aggregated/zap-reports/* aggregated/reports/ 2>/dev/null || true
          
          # Create manifest
          echo "Scan Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" > aggregated/MANIFEST.txt
          echo "Commit: ${{ github.sha }}" >> aggregated/MANIFEST.txt
          echo "Branch: ${{ github.ref_name }}" >> aggregated/MANIFEST.txt
          echo "Triggered by: ${{ github.event_name }}" >> aggregated/MANIFEST.txt
          echo "" >> aggregated/MANIFEST.txt
          echo "Contents:" >> aggregated/MANIFEST.txt
          ls -R aggregated/ >> aggregated/MANIFEST.txt
      
      - name: Upload Aggregated Results
        uses: actions/upload-artifact@v4
        with:
          name: complete-security-scan-${{ github.run_number }}
          path: aggregated/
          retention-days: 90
      
      - name: Generate Workflow Summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SAST Scan: Completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… DAST Scan: Completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AI Analysis: Completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dashboard: Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Download the complete scan results from the artifacts section above." >> $GITHUB_STEP_SUMMARY
